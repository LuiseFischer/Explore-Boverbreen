<!DOCTYPE html>
<html lang="en">
<head>
    <title>Explore Boverbreen</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.6.1/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@5.6.1/dist/maplibre-gl.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf/turf.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <base href="https://luisefischer.github.io/Explore-Boverbreen/">
</head>

<body>
<!-- Import Three JS -->
<script type="importmap">
{
    "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/"
    }
}
</script>

<!-- HTML elements -->
<div id="map"></div>

<div id="sidebar">
  <!-- Tab Modes -->
  <div class="tabs">
    <button class="tab-button active" data-tab="explore">Explore</button>
    <button class="tab-button" data-tab="tour">Tour</button>
  </div>

  <!-- Explore-Mode -->
  <div class="tab-content active" id="tab-explore">
    <!-- 2D and 3D Contents -->
    <div class="subtabs">
      <button class="subtab-button active" data-subtab="layers">2D</button>
      <button class="subtab-button" data-subtab="models">3D</button>
    </div>

    <!-- Explore: 2D -->
    <div class="subtab-content active" id="subtab-layers">
      <h3>Orthophotos</h3>
      <div class="ortho-buttons">
          <button class="layer-button" data-layer="orthos22">Ortho 22</button>
          <button class="layer-button" data-layer="orthos23">Ortho 23</button>
          <button class="layer-button" data-layer="orthos24">Ortho 24</button>
          <button class="layer-button" data-layer="orthos25">Ortho 25</button>
      </div>

      <h3>Frontlines</h3>
      <label><input type="checkbox" id="toggleFrontlines" checked>show frontlines</label>

      <h3>Changemaps</h3>
      <label for="heightSelector">Ice loss</label>
      <select id="heightSelector">
          <option value="">-- none --</option>
          <option value="heights2223">2022 - 2023</option>
          <option value="heights2324">2023 - 2024</option>
          <option value="heights2425">2024 - 2025</option>
          <option value="heights2224">2022 - 2024</option>
          <option value="heights2325">2023 - 2025</option>
          <option value="heights2225">2022 - 2025</option>
      </select>
        
      <h3>Measuring</h3>  
      <button id="toggleMeasure">Measure distance</button>
      <button class="soon-button">Measure change</button>
    </div>

     <!-- Explore: 3D -->
    <div class="subtab-content" id="subtab-models">
      <h3>3D models</h3>
      <label><input type="checkbox" id="toggleModels">show models</label>
      <select id="modelSelector">
          <option value="model25.ply">Modell 2025</option>
          <option value="model24.ply">Modell 2024</option>
          <option value="model23.ply">Modell 2023</option>
          <option value="model22.ply" selected>Modell 2022</option>
      </select>
    </div>
  </div>

    <!-- Tour-Mode -->
  <div class="tab-content" id="tab-tour">
    <!-- POIs -->
    <div class="subtabs">
      <button class="subtab-button active" data-subtab="poi1">1</button>
      <button class="subtab-button" data-subtab="poi2">2</button>
      <button class="subtab-button" data-subtab="poi3">3</button>
      <button class="subtab-button" data-subtab="poi4">4</button>
      <button class="subtab-button" data-subtab="poi5">5</button>
      <button class="subtab-button" data-subtab="poi6">6</button>
    </div>

    <!-- POI Contents -->
    <div class="subtab-content active" id="subtab-poi1">
      <h3>1-Lichenometry</h3>
      <p>There was still ice here in 1750... </p>
    </div>
    <div class="subtab-content" id="subtab-poi2">
      <h3>2-Historical photograph</h3>
      <p>At vero eos et accusam et justo</p>
    </div>
    <div class="subtab-content" id="subtab-poi3">
      <h3>3-Glacier dynamics</h3>
      <p>Lorem ipsum dolor sit amet</p>
    </div>
    <div class="subtab-content" id="subtab-poi4">
      <h3>4-Randolph Glacier Inventory</h3>
      <p>sed diam nonumy eirmod tempor invidunt ut labore</p>
    </div>
    <div class="subtab-content" id="subtab-poi5">
      <h3>5-UAV</h3>
      <p>Stet clita kasd gubergren.</p>
    </div>
    <div class="subtab-content" id="subtab-poi6">
      <h3>6-Photogrammetry</h3>
      <p>no sea takimata sanctus est</p>
    </div>
  </div>
</div>

<div id="appendix">
    <button class="soon-button">Info</button>
</div>
<div id="download">
    <button class="soon-button">Data</button>
</div>

<img id="heightLegend" src="heightmaps/legend.png" alt="Height Legend">

<div id="loadingSplash" style="
    display:none; 
    position:absolute; 
    inset:0; 
    background:rgba(255, 255, 255, 0.4); 
    font-family: 'Courier New', Courier, monospace; 
    justify-content:center; 
    align-items:center; 
    flex-direction:column; 
    z-index:1000;">
    <div>Lade Modelle...</div>
    <div style="width:300px; height:16px; background:#ffffff; border-radius:8px; margin-top:8px;">
        <div id="progressBar" style="width:0%; height:100%; background:rgb(169, 30, 230); border-radius:8px;"></div>
    </div>
</div>


<!-- Tooltips -->
<div id="tooltip" style="
  display:none;
  position:absolute;
  background:white;
  padding:4px 8px;
  border:1px solid #ccc;
  border-radius:4px;
  pointer-events:none;
  font-family: sans-serif;
  font-size:12px;
  box-shadow:0 1px 4px rgba(0,0,0,0.3);
"></div>

<div id="measureTooltip" style="
    display:none;
    position:absolute;
    background:rgba(255,255,255,0.9);
    padding:4px 8px;
    border:1px solid #ccc;
    border-radius:4px;
    font-family:sans-serif;
    font-size:12px;
    pointer-events:none;
    z-index:1000;
"></div>


<!-- Script -->
<script  type="module">
const BASE_URL = 'https://luisefischer.github.io/Explore-Boverbreen/';    
import * as THREE from 'three';
import { PLYLoader } from 'three/addons/loaders/PLYLoader.js';

const map = new maplibregl.Map({
    container: 'map',
    style: 'https://api.maptiler.com/maps/satellite/style.json?key=eIzhbDn6LNqL7hhzJdkU', //01999470-6312-7d71-bbb7-168732bad29b
    zoom: 13,
    minZoom: 11,
    maxZoom: 17,
    center: [8.05366314557974, 61.55606598139221], //lon,lat
    pitch: 60,
    bearing: 100,
    canvasContextAttributes: { antialias: true, preserveDrawingBuffer: true }
});

// load models - configs
const modelRotate = [Math.PI / 2, 0, 0];
const modelorigin = [8.05415, 61.55583];
const modelConfigs = {
    "model25.ply": { altitude: 1517.80 },
    "model24.ply": { altitude: 1517.61 },
    "model23.ply": { altitude: 1518.23 },
    "model22.ply": { altitude: 1519.11 }  
};

// load models - functions
const loadedModels = {};
let currentModelMesh = null;
const plyLoader = new PLYLoader();

function computeModelTransform(name) {
    const cfg = modelConfigs[name];
    const merc = maplibregl.MercatorCoordinate.fromLngLat(modelorigin, cfg.altitude);
    return {
        translateX: merc.x,
        translateY: merc.y,
        translateZ: merc.z,
        rotateX: modelRotate[0],
        rotateY: modelRotate[1],
        rotateZ: modelRotate[2],
        scale: merc.meterInMercatorCoordinateUnits()
    };
}

function preloadModelsSequential(scene, onProgress, onComplete) {
    const modelFiles = Object.keys(modelConfigs);
    let index = 0;

    function loadNext() {
        if (index >= modelFiles.length) {
            onComplete();
            return;
        }
        const filename = modelFiles[index];
        const transform = computeModelTransform(filename);

        plyLoader.load(`models/${filename}`, (plyGeometry) => {
            plyGeometry.computeVertexNormals();
            const plyMaterial = new THREE.MeshStandardMaterial({
                //vertexColors: true,   //enable for RGB colors
                color: 0xe0e0e0,        //disable for RGB colors
                metalness: 0.2,
                roughness: 0.5
            });
            const plyMesh = new THREE.Mesh(plyGeometry, plyMaterial);
            plyMesh.rotateX(-Math.PI / 2);

            const box = new THREE.Box3().setFromObject(plyMesh);
            const center = new THREE.Vector3();
            box.getCenter(center);
            plyMesh.position.sub(center);

            const rotationX = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(1, 0, 0), transform.rotateX);
            const rotationY = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(0, 1, 0), transform.rotateY);
            const rotationZ = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(0, 0, 1), transform.rotateZ);

            const translation = new THREE.Matrix4()
                .makeTranslation(transform.translateX, transform.translateY, transform.translateZ)
                .scale(new THREE.Vector3(transform.scale, -transform.scale, transform.scale))
                .multiply(rotationX)
                .multiply(rotationY)
                .multiply(rotationZ);

            plyMesh.userData.transform = translation;
            plyMesh.visible = false;

            scene.add(plyMesh);
            loadedModels[filename] = plyMesh;

            index++;
            onProgress(index, modelFiles.length);
            requestIdleCallback(loadNext);
        });
    }
    loadNext();
}

function showModel(name) {
    if (currentModelMesh) currentModelMesh.visible = false;
    if (loadedModels[name]) {
        currentModelMesh = loadedModels[name];
        currentModelMesh.visible = true;
    }
}

// three.js scene
const customLayer = {
    id: '3d-ply-model',
    type: 'custom',
    renderingMode: '3d',
    onAdd: function (map, gl) {
        this.camera = new THREE.Camera();
        this.scene = new THREE.Scene();

        const light1 = new THREE.DirectionalLight(0xffffff, 1);
        light1.position.set(-60, 60, 30);
        this.scene.add(light1);

        const light2 = new THREE.DirectionalLight(0xffffff, 1.5);
        light2.position.set(0, 20, 0);
        this.scene.add(light2);

        this.map = map;
        this.renderer = new THREE.WebGLRenderer({
            canvas: map.getCanvas(),
            context: gl,
            antialias: true,
            alpha: true
        });
        this.renderer.autoClear = false;

        const toggleModels = document.getElementById('toggleModels');
        const modelSelector = document.getElementById('modelSelector');
        const loadingSplash = document.getElementById('loadingSplash');
        const progressBar = document.getElementById('progressBar');

        modelSelector.disabled = true;
        let modelsLoaded = false;

        // enable / disable models
        toggleModels.addEventListener('change', () => {
            if (toggleModels.checked) {
                if (!modelsLoaded) {
                    loadingSplash.style.display = 'flex';
                    preloadModelsSequential(this.scene,
                        (loaded, total) => {
                            const percent = Math.round((loaded / total) * 100);
                            progressBar.style.width = percent + '%';
                        },
                        () => {
                            loadingSplash.style.display = 'none';
                            modelSelector.disabled = false;
                            showModel(modelSelector.value);
                            modelsLoaded = true;
                        }
                    );
                } else {
                    // enable visibility
                    showModel(modelSelector.value);
                    modelSelector.disabled = false;
                }
            } else {
                // disable visibility
                Object.values(loadedModels).forEach(m => m.visible = false);
                currentModelMesh = null;
                modelSelector.disabled = true;
            }
        });

        // current model
        modelSelector.addEventListener('change', (e) => {
            if (modelsLoaded) {
                showModel(e.target.value);
            }
        });
    },

    // render scene
    render(gl, args) {
        const m = new THREE.Matrix4().fromArray(args.defaultProjectionData.mainMatrix);
        if (currentModelMesh) {
            this.camera.projectionMatrix = m.multiply(currentModelMesh.userData.transform.clone());
        }
        this.renderer.resetState();
        this.renderer.render(this.scene, this.camera);
        this.map.triggerRepaint();
    }
};


map.on('style.load', () => {
    // ######### load contents #########
    map.addSource('terrain', {
        type: 'raster-dem',
        url: 'https://api.maptiler.com/tiles/terrain-rgb-v2/tiles.json?key=eIzhbDn6LNqL7hhzJdkU',
        tileSize: 256,
        maxzoom: 14
    });
    map.setTerrain({ source: 'terrain', exaggeration: 1 });

    //######### load contents #########
    // orthos
    const orthoCoords = [
        [8.05114218, 61.55637654], // upper left
        [8.06107026, 61.55644515], // upper right
        [8.06112271, 61.55470864], // lower left
        [8.05119519, 61.55464004]  // lower right
    ]
    const orthoLayers = [
        { id: 'orthos22', url: 'orthos/Bov_ortho_22.png', coords: orthoCoords },
        { id: 'orthos23', url: 'orthos/Bov_ortho_23.png', coords: orthoCoords },
        { id: 'orthos24', url: 'orthos/Bov_ortho_24.png', coords: orthoCoords },
        { id: 'orthos25', url: 'orthos/Bov_ortho_25.png', coords: orthoCoords }
    ];

    // heightmaps
    const heightCoords = [
        [8.0488781, 61.5604556], // upper left
        [8.0625244, 61.5604556], // upper right
        [8.0625244, 61.5492195], // upper right
        [8.0488781, 61.5492195]  // upper right
    ];
    const heightLayers = [
        { id: 'heights2223', url: 'heightmaps/Bov_M3C2_2223_WGS84.png', coords: heightCoords },
        { id: 'heights2324', url: 'heightmaps/Bov_M3C2_2324_WGS84.png', coords: heightCoords },
        { id: 'heights2425', url: 'heightmaps/Bov_M3C2_2425_WGS84.png', coords: heightCoords },
        { id: 'heights2224', url: 'heightmaps/Bov_M3C2_2224_WGS84.png', coords: heightCoords },
        { id: 'heights2325', url: 'heightmaps/Bov_M3C2_2325_WGS84.png', coords: heightCoords },
        { id: 'heights2225', url: 'heightmaps/Bov_M3C2_2225_WGS84.png', coords: heightCoords }
    ];

    // frontlines
    map.addSource('outlines', {
        type: 'geojson',
        data: 'outlines/AllOutlines_WGS84.geojson'
    });

    map.addSource('polygons', {
        type: 'geojson',
        data: 'outlines/AllPolygons_WGS84.geojson'
    });

    // POIs
    map.addSource('pois', {
        type: 'geojson',
        data: 'POIs/pois.geojson'
    });


    //######### add contents #########
    // three.js scene
    map.addLayer(customLayer);

    // raster data
    [...orthoLayers, ...heightLayers].forEach(layer => {
        map.addSource(layer.id, {
            type: 'image',
            url: layer.url,
            coordinates: layer.coords
        });
        map.addLayer({
            id: layer.id,
            type: 'raster',
            source: layer.id,
            layout: { visibility: 'none' }
        });
    });

        // heightmaps
        const heightSelector = document.getElementById('heightSelector');
        const heightLegend = document.getElementById('heightLegend');

        heightSelector.addEventListener('change', (e) => {
            const selected = e.target.value;

            // set invisible
            ['heights2223','heights2324','heights2425','heights2224','heights2325','heights2225'].forEach(layer => {
                map.setLayoutProperty(layer, 'visibility', 'none');
            });

            // set selected visible
            if (selected) {
                map.setLayoutProperty(selected, 'visibility', 'visible');
                heightLegend.style.display = 'block'; // show legend
            } else {
                heightLegend.style.display = 'none';  // remove legend
            }
        });

            // measuring mode
            let measureActive = false;
            let measurePoints = [];
            let measureMarkers = [];
            let measureLine = null;

            const toggleMeasure = document.getElementById('toggleMeasure');
            const measureTooltip = document.getElementById('measureTooltip');

            let originalMousemoveHandler = null;
            let originalMouseleaveHandler = null;

            toggleMeasure.addEventListener('click', () => {
                measureActive = !measureActive;
                toggleMeasure.classList.toggle('active', measureActive);
                toggleMeasure.textContent = measureActive ? "QUIT" : "Measure distance";

                if (measureActive) {
                    disableOtherUI();
                    measurePoints = [];
                    removeMeasureLine();
                    removeMarkers();
                    measureTooltip.style.display = 'block';
                    map.getCanvas().style.cursor = 'crosshair';

                    // disable polygonhover
                    originalMousemoveHandler = map._events?.mousemove?.geojsonFill;
                    originalMouseleaveHandler = map._events?.mouseleave?.geojsonFill;
                    map.off('mousemove', 'geojson-fill', handlePolygonHover);
                    map.off('mouseleave', 'geojson-fill', resetPolygonHover);

                } else {
                    enableOtherUI();
                    removeMeasureLine();
                    removeMarkers();
                    measurePoints = [];
                    measureTooltip.style.display = 'none';
                    map.getCanvas().style.cursor = '';

                    // enable polygo hover
                    if (originalMousemoveHandler) map.on('mousemove', 'geojson-fill', handlePolygonHover);
                    if (originalMouseleaveHandler) map.on('mouseleave', 'geojson-fill', resetPolygonHover);
                }
            });

            map.on('click', (e) => {
                if (!measureActive) return;

                const coords = [e.lngLat.lng, e.lngLat.lat];
                measurePoints.push(coords);

                // set marker
                const markerEl = document.createElement('div');
                markerEl.style.width = '6px';
                markerEl.style.height = '6px';
                markerEl.style.background = '#ff5500';
                markerEl.style.borderRadius = '50%';
                markerEl.style.position = 'absolute';
                markerEl.style.transform = 'translate(-3px, -3px)'; 
                const marker = new maplibregl.Marker({ element: markerEl })
                    .setLngLat(coords)
                    .addTo(map);
                measureMarkers.push(marker);

                // set line
                if (measurePoints.length > 1) {
                    const geojson = {
                        type: 'Feature',
                        geometry: { type: 'LineString', coordinates: measurePoints }
                    };

                    if (!map.getSource('measure-line')) {
                        map.addSource('measure-line', { type: 'geojson', data: geojson });
                        map.addLayer({
                            id: 'measure-line',
                            type: 'line',
                            source: 'measure-line',
                            paint: {
                                'line-color': '#ff5500',
                                'line-width': 2
                            }
                        });
                    } else {
                        map.getSource('measure-line').setData(geojson);
                    }
                }

                // calc dist
                let totalDistance = 0;
                for (let i = 1; i < measurePoints.length; i++) {
                    totalDistance += turf.distance(
                        turf.point(measurePoints[i - 1]),
                        turf.point(measurePoints[i]),
                        { units: 'meters' }
                    );
                }

                // show tooltip
                measureTooltip.style.display = 'block';
                measureTooltip.innerHTML = `${totalDistance.toFixed(2)} m`;
                measureTooltip.style.left = e.originalEvent.pageX + 10 + 'px';
                measureTooltip.style.top = e.originalEvent.pageY + 10 + 'px';
            });
        
            document.addEventListener('keydown', (e) => {
                if (measureActive && e.key === 'Escape') {
                    resetMeasurement();
                }
            });

        // orthos
        document.querySelectorAll('.ortho-buttons button').forEach(btn => {
            btn.addEventListener('click', () => {
                const layerId = btn.dataset.layer;

                const visibility = map.getLayoutProperty(layerId, 'visibility');

                if (visibility === 'visible') {
                    // hide layer
                    map.setLayoutProperty(layerId, 'visibility', 'none');
                    btn.classList.remove('selected');
                } else {
                    // show layer
                    map.setLayoutProperty(layerId, 'visibility', 'visible');

                    document.querySelectorAll('.ortho-buttons button').forEach(b => {
                        if (b !== btn) {
                            map.setLayoutProperty(b.dataset.layer, 'visibility', 'none');
                            b.classList.remove('selected');
                        }
                    });

                    btn.classList.add('selected');
                }
            });
        });


    // frontlines
    map.addLayer({
        id: 'geojson-fill',
        type: 'fill',
        source: 'polygons',
        paint: {
            'fill-color': [
                'case',
                ['boolean', ['feature-state', 'hover'], false],
                '#ffffff',
                '#ffffff'
            ],
            'fill-opacity': [
                'case',
                ['boolean', ['feature-state', 'hover'], false],
                0.4,
                0
            ]
        }
    });

    map.addLayer({
        id: 'geojson-line',
        type: 'line',
        source: 'outlines',
        paint: { 'line-color': '#ffffff', 
            'line-opacity': 1,
            'line-width': [
                'interpolate',
                ['linear'],
                ['zoom'],
                14, 1,
                17, 2
            ]
        }
    });

        // hover
        let hoveredFeatureId = null;
        map.on('mousemove', 'geojson-fill', (e) => {
            if (e.features.length > 0) {
                if (hoveredFeatureId !== null) {
                    map.setFeatureState(
                        { source: 'polygons', id: hoveredFeatureId },
                        { hover: false }
                    );
                }
                hoveredFeatureId = e.features[0].id;
                map.setFeatureState(
                    { source: 'polygons', id: hoveredFeatureId },
                    { hover: true }
                );

                const jahr = e.features[0].properties.Year;
                const tooltip = document.getElementById('tooltip');
                tooltip.innerHTML = `${jahr}`;
                tooltip.style.display = 'block';
                tooltip.style.left = e.originalEvent.pageX + 10 + 'px';
                tooltip.style.top = e.originalEvent.pageY + 10 + 'px';
            }
        });

        map.on('mouseleave', 'geojson-fill', () => {
            if (hoveredFeatureId !== null) {
                map.setFeatureState(
                    { source: 'polygons', id: hoveredFeatureId },
                    { hover: false }
                );
            }
            hoveredFeatureId = null;
            document.getElementById('tooltip').style.display = 'none';
        });

        // toggle checkbox
        const toggleFrontlines = document.getElementById('toggleFrontlines');
        toggleFrontlines.checked = true;

        ['geojson-line', 'geojson-fill'].forEach(layerId => {
            map.setLayoutProperty(layerId, 'visibility', 'visible');
        });

        toggleFrontlines.addEventListener('change', (e) => {
            const visibility = e.target.checked ? 'visible' : 'none';
            ['geojson-line', 'geojson-fill'].forEach(layerId => {
                map.setLayoutProperty(layerId, 'visibility', visibility);
            });
        });

    // POIs
    map.addLayer({
        id: 'pois-layer',
        type: 'circle',
        source: 'pois',
        paint: {
        'circle-radius': [
            'interpolate',
            ['linear'],
            ['zoom'],
            10, 4,   // zoom 10 → radius 4px
            13, 5,   // zoom 13 → radius 5px
            16, 7    // zoom 16 → radius 7px
        ],
         'circle-color': '#ffffff',
    }
    });

        // POI click
        map.on('click', 'pois-layer', (e) => {
            if (e.features.length > 0) {
                const feature = e.features[0];
                flyToPOI(feature);

                // get POI-ID
                const poiId = feature.id ?? feature.properties?.id;

                // get Subtab-Button
                const targetBtn = document.querySelector(`#tab-tour .subtab-button[data-subtab="poi${poiId}"]`);
                if (targetBtn) {
                    document.querySelectorAll('#tab-tour .subtab-button').forEach(b => b.classList.remove('active'));
                    targetBtn.classList.add('active');

                    // change sidebar content
                    document.querySelectorAll('#tab-tour .subtab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`subtab-poi${poiId}`).classList.add('active');

                    document.querySelectorAll('#sidebar .tab-button').forEach(b => b.classList.remove('active'));
                    document.querySelector('#sidebar .tab-button[data-tab="tour"]').classList.add('active');
                    document.querySelectorAll('#sidebar .tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById('tab-tour').classList.add('active');
                }
            }
        });

        // hover
        map.on('mouseenter', 'pois-layer', () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'pois-layer', () => {
            map.getCanvas().style.cursor = '';
        });

        
    // Modes
    document.querySelectorAll('#sidebar .tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('#sidebar .tab-button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            // contents
            document.querySelectorAll('#sidebar .tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        });
    });

    document.querySelectorAll('#sidebar .subtabs').forEach(subtabGroup => {
        const buttons = subtabGroup.querySelectorAll('.subtab-button');
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
            // Buttons innerhalb dieser Gruppe
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Inhalte innerhalb dieses Parent-Tabs
            const parent = subtabGroup.parentElement;
            parent.querySelectorAll('.subtab-content').forEach(c => c.classList.remove('active'));
            parent.querySelector('#subtab-' + btn.dataset.subtab).classList.add('active');
            });
        });
    });

        // Tour-Mode
        document.querySelectorAll('#tab-tour .subtab-button').forEach(btn => {
            btn.addEventListener('click', () => {
                const poiId = btn.dataset.subtab.replace('poi',''); 
                // get clicked poi
                const features = map.querySourceFeatures('pois');
                const unique = {};
                features.forEach(f => {
                    const id = f.id ?? f.properties?.id;
                    if (!unique[id]) {
                        unique[id] = f;
                    }
                });

                const match = unique[poiId];

                if (match) {
                    flyToPOI(match);
                } else {
                    console.error(`POI mit ID ${poiId} nicht gefunden.`);
                    console.log("Unique IDs:", Object.keys(unique));
                }
            });
        });


    // functions
    function flyToPOI(feature) {
        const coords = feature.geometry.coordinates;
        const zoom = feature.properties.zoom || 13;
        const pitch = feature.properties.pitch || 60;
        const bearing = feature.properties.bearing || 100;

        map.flyTo({
            center: coords,
            zoom,
            pitch,
            bearing,
            duration: 1500,
            curve: 1
        });
    }

    function disableOtherUI() {
        document.querySelectorAll('#sidebar button, #sidebar select, #sidebar input[type=checkbox]').forEach(el => {
            if (el !== toggleMeasure) el.disabled = true;
        });
    }

    function enableOtherUI() {
        document.querySelectorAll('#sidebar button, #sidebar select, #sidebar input[type=checkbox]').forEach(el => {
            el.disabled = false;
        });
    }

    function removeMeasureLine() {
        if (map.getLayer('measure-line')) map.removeLayer('measure-line');
        if (map.getSource('measure-line')) map.removeSource('measure-line');
        measureLine = null;
    }

    function removeMarkers() {
        measureMarkers.forEach(m => m.remove());
        measureMarkers = [];
    }

    function resetMeasurement() {
        measurePoints = [];
        removeMeasureLine();
        removeMarkers();
        measureTooltip.style.display = 'none';
    }

});    
</script>
</body>
</html>
